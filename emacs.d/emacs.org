emacs.org

* Initialisation
** Unicode
   #+BEGIN_SRC emacs-lisp :tangle yes
     (set-language-environment "UTF-8")
     (prefer-coding-system 'utf-8)
   #+END_SRC
** Windows
   Doit être proche du début !
   #+BEGIN_SRC emacs-lisp :tangle (my/tangle-p)
     (if (eq system-type 'windows-nt)
         (setq grep-program "\"c:/Program Files/Git/usr/bin/grep.exe\""
               find-program "\"c:/Program Files/Git/usr/bin/find.exe\""))
   #+END_SRC
** Custom file
   #+BEGIN_SRC emacs-lisp :tangle yes
     (setq custom-file (expand-file-name "custom.el" user-emacs-directory))
     (load custom-file)
   #+END_SRC
** Packages
   #+BEGIN_SRC emacs-lisp :tangle yes
     (fset 'yes-or-no-p 'y-or-n-p)
     (require 'use-package)
   #+END_SRC
** Server
   #+BEGIN_SRC emacs-lisp :tangle (my/tangle-p)
     (cd (getenv "HOME"))
     (server-start)
   #+END_SRC
* Interface
** Thèmes
*** zenburn
    #+BEGIN_SRC emacs-lisp :tangle yes
     (use-package zenburn-theme
       :ensure t
       :config
       (load-theme 'zenburn t))
    #+END_SRC
*** smart-mode-line
    #+BEGIN_SRC emacs-lisp :tangle (my/tangle-p)
     (use-package smart-mode-line
       :ensure t
       :init
       (use-package smart-mode-line-powerline-theme :ensure t)
       :config
       (setq sml/theme 'powerline)
       (sml/setup))
    #+END_SRC
** openwith
   #+BEGIN_SRC emacs-lisp :tangle yes
     (use-package openwith
       :ensure t
       :custom
       (openwith-associations
        (if (eq system-type 'windows-nt)
            '(("\\.\\(?:pdf\\|ps\\)\\'" "c:/Program Files/SumatraPDF/SumatraPDF"
               (file))
              ("\\.\\(?:png\\|jpg\\|jpeg\\)\\'" "start"
               (file))
              ("\\.svgz?" "start"
               (file)))
          '(("\\.\\(?:pdf\\|ps\\|png\\|jpg\\|jpeg\\|svgz?\\)\\'" "setsid -w xdg-open"
             (file)))))
       :init
       (openwith-mode))
   #+END_SRC
** company
   #+BEGIN_SRC emacs-lisp :tangle (my/tangle-p)
     (use-package company
       :ensure t
       :diminish company-mode
       :config
       (add-hook 'after-init-hook 'global-company-mode))
   #+END_SRC
** undo-tree
   #+BEGIN_SRC emacs-lisp :tangle yes
     (use-package undo-tree
       :ensure t
       :diminish undo-tree-mode
       :config
       (add-hook 'after-init-hook 'global-undo-tree-mode))
   #+END_SRC
** volatile-highlight
   #+BEGIN_SRC emacs-lisp :tangle yes
     (use-package volatile-highlights
       :ensure t
       :diminish volatile-highlights-mode
       :init
       (volatile-highlights-mode t)
       (vhl/define-extension 'undo-tree 'undo-tree-yank 'undo-tree-move)
       (vhl/install-extension 'undo-tree))
   #+END_SRC
** dired
   #+BEGIN_SRC emacs-lisp :tangle yes
     (use-package dired-x
       :commands dired-omit-mode
       :init
       (add-hook 'dired-mode-hook 'dired-omit-mode))
     (use-package diredfl
       :ensure t
       :init
       (diredfl-global-mode))
   #+END_SRC
*** icons
    #+BEGIN_SRC emacs-lisp :tangle (my/tangle-p)
      (use-package all-the-icons-dired
        :ensure t
        :defer t
        :init
        (add-hook 'dired-mode-hook 'all-the-icons-dired-mode))
    #+END_SRC
** multiple-cursors
   #+BEGIN_SRC emacs-lisp :tangle yes
     (use-package multiple-cursors
       :ensure t
       :bind ("C-c c" . mc/mark-all-dwim))
   #+END_SRC
** ace
   #+BEGIN_SRC emacs-lisp :tangle yes
     (use-package ace-window
       :ensure t
       :bind ("C-$" . ace-window))
   #+END_SRC
** ivy
   #+BEGIN_SRC emacs-lisp :tangle yes
     (use-package ivy
       :ensure t
       :diminish ivy-mode
       :init
       (ivy-mode 1)
       (setq counsel-find-file-ignore-regexp (concat (regexp-opt completion-ignored-extensions) "\\'"))
       :bind
       (("C-s" . swiper)
        ("M-x" . counsel-M-x)
        ("M-y" . counsel-yank-pop)
        ("C-x C-f" . counsel-find-file)
        ("C-!" . ivy-switch-buffer)
        ("<f1> f" . counsel-describe-function)
        ("<f1> v" . counsel-describe-variable)
        ("<f1> l" . counsel-find-library)
        ("<f2> i" . counsel-info-lookup-symbol)
        ("<f2> u" . counsel-unicode-char)
        ("C-c g" . counsel-git)
        ("C-c j" . counsel-git-grep)
        ("C-c k" . counsel-ag)
        ("C-c r" . counsel-mark-ring)
        ("C-c C-r" . ivy-resume)))
     (use-package ivy-hydra :ensure t)
   #+END_SRC
*** icons
    #+BEGIN_SRC emacs-lisp :tangle (my/tangle-p)
      (use-package all-the-icons-ivy
        :ensure t
        :init (all-the-icons-ivy-setup))
    #+END_SRC
*** projectile
    #+BEGIN_SRC emacs-lisp :tangle yes
      (use-package counsel-projectile
        :ensure t
        :diminish projectile-mode
        ;; https://github.com/dmacvicar/dotfiles/commit/e07170e4378d84bf17415d49c0e820f32de49503
        :preface (setq projectile-keymap-prefix (kbd "C-c p"))
        :init (counsel-projectile-mode))
    #+END_SRC
** smartparens
   #+BEGIN_SRC emacs-lisp :tangle yes
     (use-package smartparens-config
       :ensure smartparens
       :diminish smartparens-mode
       :init
       (smartparens-global-mode)
       (sp-use-smartparens-bindings))
   #+END_SRC
** Divers
   #+BEGIN_SRC emacs-lisp :tangle yes
     (setq ring-bell-function 'ignore)
     (use-package uniquify)
     (use-package diminish :ensure t)
     (use-package hippie-exp :bind ("M-/" . hippie-expand))
     (use-package eshell :bind ("C-c e" . eshell))
     (use-package recentf :config (recentf-mode 1))
     (setq backup-directory-alist `(("." . ,(expand-file-name "saves" user-emacs-directory))))
   #+END_SRC
   Disable stupid stuff...
   #+BEGIN_SRC emacs-lisp :tangle yes
     (global-unset-key (kbd "C-z"))
     (global-unset-key (kbd "<f9>"))
     (global-unset-key (kbd "<insert>"))
     (setq disabled-command-function nil)
   #+END_SRC
* org
  #+BEGIN_SRC emacs-lisp :tangle (my/tangle-p)
    (use-package org
      :ensure t
      :bind (("C-c a" . org-agenda)
             ("C-c l" . org-store-link)
             ("C-c o" . org-capture)))
  #+END_SRC
* Programmation
** LaTeX
*** reftex
    Must come before latex.
    #+BEGIN_SRC emacs-lisp :tangle (my/tangle-p)
      (use-package reftex
        :ensure t
        :defer t
        :config
        (add-to-list 'reftex-bibliography-commands "addbibresource")
        (setq reftex-default-bibliography
              (expand-file-name "bibtex/bib/mainbib.bib" (getenv "TEXMFHOME"))))
    #+END_SRC
*** latex
    #+BEGIN_SRC emacs-lisp :tangle (my/tangle-p)
      (use-package latex
        :ensure auctex
        :mode ("\\.tex'" . latex-mode)
        :bind (:map LaTeX-mode-map ("C-c C-k" . my-TeX-kill-job))
        :init
        (setq ispell-tex-skip-alists
              (list
               (append
                (car ispell-tex-skip-alists)
                '(("\\\\cref" ispell-tex-arg-end)
                  ("\\\\Cref" ispell-tex-arg-end)
                  ("\\\\import" ispell-tex-arg-end 2)
                  ("\\\\textcite" ispell-tex-arg-end)))
               (cadr ispell-tex-skip-alists)))
        ;; hooks
        (add-hook 'LaTeX-mode-hook 'turn-on-reftex)
        (add-hook 'LaTeX-mode-hook 'turn-on-flyspell)
        (add-hook 'LaTeX-mode-hook 'LaTeX-math-mode)
        (add-hook 'LaTeX-mode-hook 'TeX-source-correlate-mode)
        (add-hook 'LaTeX-mode-hook 'prettify-symbols-mode)
        (add-hook 'LaTeX-mode-hook
                  (lambda ()
                    (setq TeX-command-default "LatexMk"
                          ;; I don't know why AUCTeX devs think they know better...
                          company-minimum-prefix-length 3)))
        :config
        ;; mathfrak font
        (add-to-list 'LaTeX-font-list '(11 "" "" "\\mathfrak{" "}"))

        ;; prettify!
        (with-eval-after-load 'tex
          (dolist
              (elt '(("\\coloneqq" . ?≔) ("\\vartheta" . ?ϑ) ("\\varnothing" . ?∅) ("\\varpi" . ?ϖ) ("\\implies" . ?⟹) ("\\dots" . ?…) ("\\item" . ?*) ("\\og" . ?«) ("\\fg" . ?»)))
            (add-to-list 'tex--prettify-symbols-alist elt)))

        ;; LaTeXmk
        (use-package auctex-latexmk :ensure t)
        (auctex-latexmk-setup)
        ;; Custom kill function
        (defun my-TeX-kill-job ()
          "Kill the currently running TeX job but ask for confirmation before."
          (interactive)
          (let ((process (TeX-active-process)))
            (if process
                (if (y-or-n-p "Kill current TeX process?")
                    (kill-process process)
                  (error "Canceled kill."))
              ;; Should test for TeX background process here.
              (error "No TeX process to kill"))))
  
        ;; viewers
        (setq TeX-view-program-list
              '(("Sumatra PDF"
                 ("\"C:/Program Files/SumatraPDF/SumatraPDF.exe\" -reuse-instance"
                  (mode-io-correlate " -forward-search \"%b\" %n")
                  " %o")))
              TeX-view-program-selection
              (if (eq system-type 'windows-nt)
                  '((output-pdf "Sumatra PDF")
                    ((output-dvi style-pstricks)
                     "dvips and gv")
                    (output-dvi "xdvi")
                    (output-html "xdg-open"))
                '((output-pdf "Okular")
                  ((output-dvi style-pstricks) "dvips and gv")
                  (output-dvi "xdvi")
                  (output-html "xdg-open")))))
    #+END_SRC
*** Fonts
    Used for folding.
    #+BEGIN_SRC emacs-lisp :tangle (my/tangle-p)
      (if (display-graphic-p)
          (dolist (range '((#x2200 . #x23ff) (#x27c0 . #x27ff) (#x2980 . #x2bff) (#x1d400 . #x1d7ff)))
            (set-fontset-font
             "fontset-default"
             (cons (decode-char 'ucs (car range)) (decode-char 'ucs (cdr range)))
             "STIX")))
    #+END_SRC
*** ebib
    #+BEGIN_SRC emacs-lisp :tangle (my/tangle-p)
      (use-package ebib
        :ensure t
        :bind ("C-c b" . ebib)
        :config
        (setq ebib-bib-search-dirs
              (list (expand-file-name "bibtex/bib" (getenv "TEXMFHOME")))
              ebib-file-search-dirs (list (expand-file-name "papers" my/nextcloud-dir)))
        (let ((command (if (eq system-type 'windows-nt) "c:/Program Files/SumatraPDF/SumatraPDF.exe" "nohup xdg-open %s")))
          (setq ebib-file-associations
                `(("pdf" . ,command)
                  ("ps" . ,command)
                  ("djvu" . ,command)))))
    #+END_SRC
** julia
   #+BEGIN_SRC emacs-lisp :tangle (my/tangle-p)
     (use-package julia-mode
       :ensure t
       :mode "\\.jl\\'")
     (use-package julia-repl
       :ensure t
       :defer t
       :init (add-hook 'julia-mode-hook 'julia-repl-mode))
   #+END_SRC
** Typescript
   #+BEGIN_SRC emacs-lisp :tangle no
     (defun setup-tide-mode ()
       "Setup tide-mode."
       (interactive)
       (tide-setup)
       (flycheck-mode +1)
       (setq flycheck-check-syntax-automatically '(save mode-enabled))
       (eldoc-mode +1)
       (tide-hl-identifier-mode +1))
     (use-package tide
       :ensure t
       :commands tide-setup
       :config
       (setq tide-format-options
             '(:insertSpaceAfterFunctionKeywordForAnonymousFunctions t
               :placeOpenBraceOnNewLineForFunctions nil)))
     (use-package typescript-mode
       :ensure t
       :mode "\\.ts'"
       :init
       (add-hook 'before-save-hook 'tide-format-before-save)
       (add-hook 'typescript-mode-hook 'setup-tide-mode))
   #+END_SRC
** Divers
   #+BEGIN_SRC emacs-lisp :tangle yes
     (use-package cperl-mode
       :mode "\\.\\([pP][Llm]\\|al\\)\\'"
       :interpreter ("perl" "perl5" "miniperl"))
     (use-package markdown-mode
       :ensure t
       :mode ("\\.markdown?\\'" "\\.md?\\'"))
     (use-package web-mode
       :ensure t
       :mode ("\\.\\([tT][tT]\\)\\'" ; template toolkit
              "\\.phtml\\'" "\\.tpl\\.php\\'" "\\.[agj]sp\\'" "\\.as[cp]x\\'"
              "\\.erb\\'" "\\.mustache\\'" "\\.djhtml\\'" "\\.html?\\'" "\\.jsx?\\'" "\\.s?css\\'"))
     (use-package sass-mode
       :ensure t
       :mode "\\.scss?\\'")
     (use-package jade-mode
       :ensure t
       :mode "\\.jade\\'")
     (use-package rainbow-delimiters
       :ensure t
       :init
       (add-hook 'prog-mode-hook 'rainbow-delimiters-mode))
     ;; (use-package elpy
     ;;   :ensure t
     ;;   :defer t
     ;;   :init
     ;;   (advice-add 'python-mode :before 'elpy-enable))
   #+END_SRC
* Git
** Magit
   #+BEGIN_SRC emacs-lisp :tangle yes
     (use-package magit
       :ensure t
       :bind ("C-c m" . magit-status)
       :config
       (global-magit-file-mode)
       (setq magit-last-seen-setup-instructions "1.4.0")
       (if (eq system-type 'windows-nt)
           (setenv "SSH_ASKPASS" "git-gui--askpass")))
   #+END_SRC
** diff-hl
   #+BEGIN_SRC emacs-lisp :tangle yes
     (use-package diff-hl
       :ensure t
       :init
       (global-diff-hl-mode)
       (if (not (eq system-type 'windows-nt))
           (add-hook 'dired-mode-hook 'diff-hl-dired-mode-unless-remote))
       (add-hook 'magit-post-refresh-hook 'diff-hl-magit-post-refresh))
   #+END_SRC
** misc
   #+BEGIN_SRC emacs-lisp :tangle yes
     (use-package gitconfig-mode :ensure t)
     (use-package gitignore-mode :ensure t)
   #+END_SRC
* Divers
  #+BEGIN_SRC emacs-lisp :tangle yes
    (use-package woman
      :bind ("C-c w" . woman))
    (if (eq system-type 'windows-nt)
        (setq browse-url-browser-function 'browse-url-default-windows-browser))
  #+END_SRC
